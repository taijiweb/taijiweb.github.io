<!DOCTYPE html><html lang="zh-CN,en,default"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>React 与 Domcom 面对面 -- 评论框教程 | taijiweb's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">React 与 Domcom 面对面 -- 评论框教程</h1><a id="logo" href="/.">taijiweb's blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">React 与 Domcom 面对面 -- 评论框教程</h1><div class="post-meta">Aug 9, 2016<span> | </span><span class="category"><a href="/categories/Domcom/">Domcom</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/08/09/从React教程学Domcom/" href="/2016/08/09/从React教程学Domcom/#comments" class="ds-thread-count"></a><div class="post-content"><p>本文关于React的所有代码出自<a href="https://facebook.github.io/react/docs/tutorial.html" target="_blank" rel="external">React Tutorial</a>。关于案例本身以及React的中文解说出自<a href="http://reactjs.cn/react/index.html" target="_blank" rel="external">React 中文社区对React Tutorial的翻译</a>，略有改动。其余部分为本人原创。上述相关方以及各位读者如果觉得本文有侵权或其它不妥之处，敬请告知taijiweeb@gmail.com，本人将做适当修改，谢谢。</p>
<h2 id="构造一个评论组件"><a href="#构造一个评论组件" class="headerlink" title="构造一个评论组件"></a>构造一个评论组件</h2><p>我们将构建一个简单却真实的评论框，你可以将它放入你的博客，类似于 disqus 、 livefyre 、 facebook 中实时评论框，包含一些基础功能。我们将提供以下功能：</p>
<ul>
<li>展示所有评论的界面</li>
<li>发布评论的表单</li>
<li>后端 API 接口地址，该接口需要自己实现 </li>
</ul>
<p>同时也包含一些简洁的特性：</p>
<ul>
<li>发布评论的体验优化： 评论在保存到服务器之前就展现在评论列表，因此感觉起来很快。</li>
<li>实时更新： 其他用户的评论将会实时展示在评论框中。</li>
<li>Markdown格式： 用户可以使用Markdown语法来编辑评论文本。</li>
</ul>
<hr>
<h2 id="运行一个服务器"><a href="#运行一个服务器" class="headerlink" title="运行一个服务器"></a>运行一个服务器</h2><p>为了开始本教程，我们将需要一个运行的服务器，提供一个 API 接口，仅用于获取和保存评论数据。为了尽量简便，我们已经准备好了几种脚本语言开发的简单服务器程序，完成了我们需要的功能。你可以查看<a href="https://github.com/taijiweb/domcom-tutorial">源码</a>或者<a href="https://github.com/taijiweb/domcom-tutorial/archive/master.zip">下载 zip 文件</a>，里面包含了开始学习教程所需的所有东西。</p>
<p>为了简单，服务器将会使用一个 JSON 文件作为数据库。不能在生产环境中采用这种做法，但是这样做确实简化了模拟后端 API 的工作。一旦启动了这个服务器，它就能提供我们需要的 API 接口，同时也能生成并发送我们需要的页面。</p>
<hr>
<h2 id="设置html页面"><a href="#设置html页面" class="headerlink" title="设置html页面"></a>设置html页面</h2><p>本教程会尽量简单。上述讨论提及的页面是一个 HTML 文件，它包含在服务器源码包中，我们先看看这个文件。使用你最喜欢的编辑器打开 public/index.html ，然后会看见这些内容：</p>
<h4 id="React"><a href="#React" class="headerlink" title="React"></a>React</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- index.html --&gt;</span></div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>React Tutorial<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://npmcdn.com/react@15.3.0/dist/react.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://npmcdn.com/react-dom@15.3.0/dist/react-dom.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://npmcdn.com/babel-core@5.8.38/browser.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://npmcdn.com/jquery@3.1.0/dist/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://npmcdn.com/remarkable@1.6.2/dist/remarkable.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span> <span class="attr">src</span>=<span class="string">"scripts/example.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span><span class="javascript"></span></div><div class="line">      <span class="comment">// 在本教程的剩下部分，我们会在这个 script 标签中编写我们的 JavaScript 代码。</span></div><div class="line">      <span class="comment">// 我们没有任何高端的页面自动加载刷新工具，所以在修改了代码之后，需要手动刷新浏览器来查看变化。</span></div><div class="line">      <span class="comment">// 下面，启动服务器，在浏览器中打开 http://localhost:3000 。</span></div><div class="line">      <span class="comment">// 在没对源码进行修改的前提下，第一次打开这个 URL 会看到我们计划构建的应用的一个最终样子。</span></div><div class="line">      <span class="comment">// 当你完成本教程，需要使用外部javascript文件的时候，只需要删掉这个 `&lt;script&gt;` 标签就可以了。</span></div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<blockquote>
<p>因为我们想简化 ajax 请求代码，所以在这里引入 jQuery，但是 React 并不依赖于 jQuery 。</p>
</blockquote>
<h4 id="Domcom"><a href="#Domcom" class="headerlink" title="Domcom"></a>Domcom</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- index.html --&gt;</span></div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Domcom Tutorial<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.jsdelivr.net/domcom/0.5.2/domcom.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://npmcdn.com/jquery@3.1.0/dist/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- domcom 可以很方便地使用 ES5 原生代码来编写。因此并不需要包含babel --&gt;</span></div><div class="line">    <span class="comment">&lt;!-- script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"&gt;&lt;/script --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://npmcdn.com/remarkable@1.6.2/dist/remarkable.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"scripts/example.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">      <span class="comment">// 在本教程的剩下部分，我们会在这个 script 标签中编写我们的 JavaScript 代码。</span></div><div class="line">      <span class="comment">// 我们没有任何高端的页面自动加载刷新工具，所以在修改了代码之后，需要手动刷新浏览器来查看变化。</span></div><div class="line">      <span class="comment">// 下面，启动服务器，在浏览器中打开 http://localhost:3000 。</span></div><div class="line">      <span class="comment">// 在没对源码进行修改的前提下，第一次打开这个 URL 会看到我们计划构建的应用的一个最终样子。</span></div><div class="line">      <span class="comment">// 当你完成本教程，需要使用外部javascript文件的时候，只需要删掉这个 `&lt;script&gt;` 标签就可以了。</span></div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>因为Domcom所有的api都在dc名字空间上，因此使用dc本身并不要求使用babel之类的工具。本教程的Domcom代码仅使用了两项ES6特征：解构赋值和const关键词。因此只要把解构赋值语句用ES5语法重写，将const关键词用var替换，代码即已经符合ES5标准。当然，使用ES6会让代码更简洁一些，使用babel预编译还是鼓励的。</p>
<blockquote>
<p>为行文方便，文中涉及的dc名字空间的API名称并没有一一声明和导入。这些名字包括div, span, h1, h2, input, text, html, $model, flow(flow.bind, flow.bindings)等。实际编码时需要根据ES6或ES5的不同语法加以处理。请留意。</p>
</blockquote>
<p><strong>注意</strong></p>
<blockquote>
<p>因为我们想简化 ajax 请求代码，所以在这里引入 jQuery，但是 Domcom 并不依赖于<strong>任何其它库</strong>，也包括 jQuery 。</p>
</blockquote>
<hr>
<h2 id="第一个部件"><a href="#第一个部件" class="headerlink" title="第一个部件"></a>第一个部件</h2><h4 id="React-1"><a href="#React-1" class="headerlink" title="React"></a>React</h4><p>React中全是模块化、可组装的组件。</p>
<blockquote>
<p>React框架不支持OOP编程范式。虽然React有createClass，或者extends Comopnent，但是所有React组件都只能平坦地扩展Component，因为在React框架下无法按照类继承的方式扩展部件，不存在什么类继承层次体系。</p>
</blockquote>
<h4 id="Domcom-1"><a href="#Domcom-1" class="headerlink" title="Domcom"></a>Domcom</h4><p>Domcom也是基于部件的框架。所有部件都是模块化，可组装的，组合性更胜于React的组件。另外还有一个显著不同，Domcom部件支持通过OOP方式进行扩展。</p>
<p>为了区别于React，Domcom将使用部件而不是组件这一概念。</p>
<blockquote>
<p>可以看到，本教程中Domcom表现得比React更加贴近函数式编程，没有体现出任何与OOP有关的特征，因此必须在这里特别地强调OOP的重要性。在GUI领域，OOP是非常重要的。只要熟悉GUI编程（比如MFC，WPF，Qt，WxWidgets, Android UI，cocoa等等）的人都应该理解这一点，不被某些错误的言论误导。在web前端开发领域就有很多这方面的错误言论。不得不说，出于掩护自身设计缺陷和推广框架的原因，React社区也是推波助澜者之一。</p>
</blockquote>
<p>对于我们的评论框例子，我们将有如下的React组件（或者Domcom部件）结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- CommentBox  </div><div class="line">  - CommentList  </div><div class="line">    - Comment  </div><div class="line">  - CommentForm</div></pre></td></tr></table></figure>
<h4 id="React-2"><a href="#React-2" class="headerlink" title="React"></a>React</h4><p>让我们构造 CommentBox 组件，它只是一个简单的 <code>&lt;div&gt;</code> ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial1.js</span></div><div class="line"><span class="keyword">var</span> CommentBox = React.createClass(&#123;</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"commentBox"</span>&gt;</span></span></div><div class="line">        Hello, world! I am a CommentBox.</div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line">ReactDOM.render(</div><div class="line">  <span class="xml"><span class="tag">&lt;<span class="name">CommentBox</span> /&gt;</span>,</span></div><div class="line">  document.getElementById('content')</div><div class="line">);</div></pre></td></tr></table></figure>
<p>注意，原生 HTML 元素名以小写字母开头，而自定义的 React 类名以大写字母开头。</p>
<h5 id="不用JSX"><a href="#不用JSX" class="headerlink" title="不用JSX"></a>不用JSX</h5><p>首先你注意到 JavaScript 代码中 XML 式的语法语句。我们有一个简单的预编译器，用于将这种语法糖转换成纯 JavaScript 代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial1-raw.js</span></div><div class="line"><span class="keyword">var</span> CommentBox = React.createClass(&#123;<span class="attr">displayName</span>: <span class="string">'CommentBox'</span>,</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      React.createElement(<span class="string">'div'</span>, &#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;,</div><div class="line">        <span class="string">"Hello, world! I am a CommentBox."</span></div><div class="line">      )</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line">ReactDOM.render(</div><div class="line">  React.createElement(CommentBox, <span class="literal">null</span>),</div><div class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'content'</span>)</div><div class="line">);</div></pre></td></tr></table></figure>
<p>JSX 语法是可选的，但是我们发现 JSX 语句比纯 JavaScript 用起来更容易。更多内容请阅读《 JSX 语法介绍》。</p>
<ul>
<li>发生了什么  </li>
</ul>
<blockquote>
<p>我们通过 JavaScript 对象传递一些方法到 React.createClass() 来创建一个新的 React 组件。其中最重要的方法是 render ，该方法返回一棵 React 组件树，这棵树最终将会渲染成 HTML 。<br>这里的 div 标签不是真正的 DOM 节点；他们是 React div 组件的实例。你可以认为这些标签就是一些标记或者数据， React 知道如何处理它们。React 是安全的。我们不生成 HTML 字符串，因此默认阻止了 XSS 攻击。<br>没必要返回基本的 HTML 结构，可以返回一个你（或者其他人）创建的组件树。而这就是让 React 变得组件化 的特性：一个前端可维护性的关键原则。  </p>
<p>ReactDOM.render() 实例化根组件，启动框架，把标记注入到第二个参数指定的原生的 DOM 元素中。<br>ReactDOM 模块提供了一些 DOM 相关的方法，而 React 模块包含了 React 团队分享的不同平台上的核心工具（例如， React Native ）。</p>
</blockquote>
<h4 id="Domcom-2"><a href="#Domcom-2" class="headerlink" title="Domcom"></a>Domcom</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123;div&#125; = dc;</div><div class="line"><span class="keyword">var</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">  <span class="string">"Hello, world! I am a CommentBox."</span></div><div class="line">);</div><div class="line">commentBox.mount();</div></pre></td></tr></table></figure>
<ul>
<li>Domcom无需JSX，代码更为简洁优雅。</li>
</ul>
<blockquote>
<p>Domcom框架在设计时致力于提供简洁优雅的Javascript语言API，以避免依赖于XML风格的语法。作为Domcom的框架作者，我认为，在框架已经以Javascript代码形式的部件完全掌控了几乎所有页面内容的情况下，以JSX而不是API的角度来解决问题，这是观念的落后和妥协，导致的是丑陋的代码、复杂的工具链以及诸多相关的问题，并不是完全必要的。本教程的代码对比印证了这一点。事实上，domcom的代码不管以coffee-script，ES6， ES5编写在简洁程度上都能胜过jsx。当然，domcom也是可以提供类xml风格的模板的。但是我认为这种观念的转变是更加重要的。</p>
</blockquote>
<hr>
<h2 id="制作组件"><a href="#制作组件" class="headerlink" title="制作组件"></a>制作组件</h2><p>让我们为 CommentList 和 CommentForm 搭建骨架，它们也是由一些简单的 <code>&lt;div&gt;</code> 组成。将这两个组件的代码添加到你的源码文件中，保留已有的 CommentBox 声明和 ReactDOM.render 调用：</p>
<h4 id="React-3"><a href="#React-3" class="headerlink" title="React"></a>React</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial2.js</span></div><div class="line"><span class="keyword">var</span> CommentList = React.createClass(&#123;</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"commentList"</span>&gt;</span></span></div><div class="line">        Hello, world! I am a CommentList.</div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">var</span> CommentForm = React.createClass(&#123;</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"commentForm"</span>&gt;</span></span></div><div class="line">        Hello, world! I am a CommentForm.</div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="Domcom-3"><a href="#Domcom-3" class="headerlink" title="Domcom"></a>Domcom</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123;div&#125; = dc;</div><div class="line"><span class="keyword">const</span> commentList = div(&#123;<span class="attr">className</span>: <span class="string">"commentList"</span>&#125;,</div><div class="line">        <span class="string">"Hello, world! I am a CommentList."</span></div><div class="line">);</div><div class="line"><span class="keyword">const</span> CommentForm = div(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">        <span class="string">"Hello, world! I am a commentForm."</span></div><div class="line">);</div></pre></td></tr></table></figure>
<hr>
<p>接下来，使用新创建的组件更新 CommentBox 组件代码：</p>
<h4 id="React-4"><a href="#React-4" class="headerlink" title="React"></a>React</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial3.js</span></div><div class="line"><span class="keyword">var</span> CommentBox = React.createClass(&#123;</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"commentBox"</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Comments<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">CommentList</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">CommentForm</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>注意我们是如何整合 HTML 标签和我们所创建的组件的。 HTML 组件就是普通的 React 组件，就和你定义的组件一样，只不过有一处不同。 JSX 编译器会自动重写 HTML 标签为 React.createElement(tagName) 表达式，其它什么都不做。这是为了避免全局命名空间污染。</p>
<h4 id="Domcom-4"><a href="#Domcom-4" class="headerlink" title="Domcom"></a>Domcom</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">  h1(<span class="string">"Comments"</span>),</div><div class="line">  commentList,</div><div class="line">  commentForm</div><div class="line">);</div></pre></td></tr></table></figure>
<hr>
<h2 id="传递数据"><a href="#传递数据" class="headerlink" title="传递数据"></a>传递数据</h2><h4 id="React-5"><a href="#React-5" class="headerlink" title="React"></a>React</h4><p>在React中数据是通过props和state来管理的。不变的数据用props，变化的数据用state。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial4.js</span></div><div class="line"><span class="keyword">var</span> Comment = React.createClass(&#123;</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"comment"</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">h2</span> <span class="attr">className</span>=<span class="string">"commentAuthor"</span>&gt;</span></div><div class="line">          &#123;this.props.author&#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line">        &#123;this.props.children&#125;</div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在 JSX 中，通过使用大括号包住一个 JavaScript 表达式（例如作为属性或者儿子节点），你可以在树结构中生成文本或者 React 组件。我们通过 this.props 来访问传入组件的数据，键名就是对应的命名属性，也可以通过 this.props.children 访问组件内嵌的任何元素。</p>
<h4 id="Domcom-5"><a href="#Domcom-5" class="headerlink" title="Domcom"></a>Domcom</h4><p>Domcom中可以直接通过函数参数传递数据。  </p>
<blockquote>
<p>对于AngularJS，ReactJS的数据传递机制（AngularJS是耦合于Scope的层次，ReactJS是耦合于组件的props和state层次），我联想到TJ Holowaychuk关于AngularJS模块设计机制的疑问：Why not just require？类似地，为什么不简单地利用函数及其参数来传递数据呢？这难道不是各种编程语言都提供的最普遍最自然的构造吗？Domcom正是充分利用这种方法实现了更好的数据传递与数据管理，实现了view和controllor以及model之间更充分的解耦，消除了层次化耦合数据这一重大的限制，从而实现了更灵活、更强大、解耦更彻底的数据传递和数据管理，能更好地支持MVC、MVVM或者flux等设计模式。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeComment</span>(<span class="params">author, content</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> div(&#123;<span class="attr">className</span>: <span class="string">"comment"</span>&#125;,</div><div class="line">    h2(&#123;<span class="attr">className</span>: <span class="string">"commentAuthor"</span>&#125;, author),</div><div class="line">    content</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="组件属性"><a href="#组件属性" class="headerlink" title="组件属性"></a>组件属性</h3><h4 id="React-6"><a href="#React-6" class="headerlink" title="React"></a>React</h4><p>现在我们定义了 Comment 组件，我们想传递给它作者名字和评论文本，以便于我们能够对每一个独立的评论重用相同的代码。首先让我们添加一些评论到 CommentList ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial5.js</span></div><div class="line"><span class="keyword">var</span> CommentList = React.createClass(&#123;</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"commentList"</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">Comment</span> <span class="attr">author</span>=<span class="string">"Pete Hunt"</span>&gt;</span>This is one comment<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Comment</span> <span class="attr">author</span>=<span class="string">"Jordan Walke"</span>&gt;</span>This is *another* comment<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>请注意，我们从父 CommentList 组件传递给子 Comment 组件一些数据。例如，我们传递了 Pete Hunt （通过属性）和 This is one comment （通过类似于 XML 的子节点）给第一个 Comment 组件。正如前面说的那样， Comment 组件通过 this.props.author 和 this.props.children 来访问这些“属性”。</p>
<h4 id="Domcom-6"><a href="#Domcom-6" class="headerlink" title="Domcom"></a>Domcom</h4><p>在Domcom中只是简单的函数调用和传递参数，这在任何编程语言里面都是最自然不过的方法：    </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">const commentList = div(&#123;className: "commentList"&#125;, </div><div class="line">  makeComment("张三", "这是条评论"),</div><div class="line">  makeComment("李四“，”这是**另一条**评论“）</div><div class="line">);</div></pre></td></tr></table></figure>
<hr>
<h2 id="添加-Markdown-语法格式的评论"><a href="#添加-Markdown-语法格式的评论" class="headerlink" title="添加 Markdown 语法格式的评论"></a>添加 Markdown 语法格式的评论</h2><p>Markdown 是一种简单的格式化内联文本的方式。例如，用星号包裹文本将会使其强调突出。</p>
<h4 id="React-7"><a href="#React-7" class="headerlink" title="React"></a>React</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial6.js</span></div><div class="line"><span class="keyword">var</span> Comment = React.createClass(&#123;</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> md = <span class="keyword">new</span> Remarkable();</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"comment"</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">h2</span> <span class="attr">className</span>=<span class="string">"commentAuthor"</span>&gt;</span></div><div class="line">          &#123;this.props.author&#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line">        &#123;md.render(this.props.children.toString())&#125;</div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="Domcom-7"><a href="#Domcom-7" class="headerlink" title="Domcom"></a>Domcom</h4><p>为了显示Html，Domcom提供了html部件。使用html部件时会将用户内容渲染为dom结构，面对这种需求务必对可能的安全风险保持警惕。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> md = Remarkable();</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeComment</span>(<span class="params">author, content</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> div(&#123;<span class="attr">className</span>: <span class="string">"comment"</span>&#125;,</div><div class="line">    h2(&#123;<span class="attr">className</span>: <span class="string">"commentAuthor"</span>&#125;, author),</div><div class="line">    html(md.render(content))</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不象react的props.children是部件，Domcom中的函数参数可以是任何数据，因此content会保持是文本，无需react中的转为字符串的步骤。</p>
<h4 id="React-8"><a href="#React-8" class="headerlink" title="React"></a>React</h4><p>但是这里有一个问题！我们渲染的评论内容在浏览器里面看起来像这样：<code>&lt;p&gt;This is &lt;em&gt;another&lt;/em&gt; comment&lt;/p&gt;</code>。我们希望这些标签能够真正地渲染成 HTML 。</p>
<p>那是 React 在保护你免受 XSS 攻击。这里有一种方法解决这个问题，但是框架会警告你别使用这种方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial7.js</span></div><div class="line"><span class="keyword">var</span> Comment = React.createClass(&#123;</div><div class="line">  <span class="attr">rawMarkup</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> md = <span class="keyword">new</span> Remarkable();</div><div class="line">    <span class="keyword">var</span> rawMarkup = md.render(<span class="keyword">this</span>.props.children.toString());</div><div class="line">    <span class="keyword">return</span> &#123; <span class="attr">__html</span>: rawMarkup &#125;;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"comment"</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">h2</span> <span class="attr">className</span>=<span class="string">"commentAuthor"</span>&gt;</span></div><div class="line">          &#123;this.props.author&#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">dangerouslySetInnerHTML</span>=<span class="string">&#123;this.rawMarkup()&#125;</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这是一个特殊的 API，故意让插入原始的 HTML 变得困难，但是对于 markdown ，我们将利用这个后门。记住： 使用这个功能，你的代码就要依赖于 remarkable 的安全性。</p>
<h4 id="Domcom-8"><a href="#Domcom-8" class="headerlink" title="Domcom"></a>Domcom</h4><p>使用html部件会将text渲染为dom结构。因此前一个步骤所使用的html部件的结果已经正好是我们想要的。当然这会存在安全风险，是编码时要注意的。Domcom并没有为此就特意将api搞得更丑，而是在文档中多加提醒。并且在api上更方便让程序员添加转义处理，方法是让html部件函数可以提供一个变换函数作为transform参数。上述代码在Domcom中可以这样实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> md = Remarkable();</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">convertMarkdown</span>(<span class="params">text</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> md.render(text);</div><div class="line">&#125;;</div><div class="line"><span class="keyword">const</span> comment = <span class="function"><span class="keyword">function</span> (<span class="params">author, content</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> div(&#123;<span class="attr">className</span>: <span class="string">"comment"</span>&#125;,</div><div class="line">    h2(&#123;<span class="attr">className</span>: <span class="string">"commentAuthor"</span>&#125;, author),</div><div class="line">    html(content, convertMarkdown)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>甚至可以更简单：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> md = Remarkable();</div><div class="line"><span class="keyword">const</span> comment = <span class="function"><span class="keyword">function</span> (<span class="params">author, content</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> div(&#123;<span class="attr">className</span>: <span class="string">"comment"</span>&#125;,</div><div class="line">    h2(&#123;<span class="attr">className</span>: <span class="string">"commentAuthor"</span>&#125;, author),</div><div class="line">    html(content, md.render.bind(md))</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="接入数据模型"><a href="#接入数据模型" class="headerlink" title="接入数据模型"></a>接入数据模型</h2><p>到目前为止，我们已经在源代码里面直接插入了评论数据。让我们将这些评论数据抽出来，放在一个 JSON 格式的变量中，然后将这个 JSON 数据渲染到评论列表。到最后，数据将会来自服务器，但是现在直接写在源代码中（这一步骤下React和Domcom都会采用这一段代码）：  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial8.js</span></div><div class="line"><span class="keyword">var</span> data = [</div><div class="line">  &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">author</span>: <span class="string">"Pete Hunt"</span>, <span class="attr">text</span>: <span class="string">"This is one comment"</span>&#125;,</div><div class="line">  &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">author</span>: <span class="string">"Jordan Walke"</span>, <span class="attr">text</span>: <span class="string">"This is *another* comment"</span>&#125;</div><div class="line">];</div></pre></td></tr></table></figure>
<h4 id="React-9"><a href="#React-9" class="headerlink" title="React"></a>React</h4><p>我们希望将数据以模块化的方式传递进CommentList，因此我们修改CommentBox和ReactDOM.render()调用通过props来传递数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial9.js</span></div><div class="line"><span class="keyword">var</span> CommentBox = React.createClass(&#123;</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div className="commentBox"&gt;</div><div class="line">        &lt;h1&gt;Comments&lt;/h1&gt;</div><div class="line">        &lt;CommentList data=&#123;this.props.data&#125; /&gt;</div><div class="line">        &lt;CommentForm /&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">ReactDOM.render(</div><div class="line">  &lt;CommentBox data=&#123;data&#125; /&gt;,</div><div class="line">  document.getElementById('content')</div><div class="line">);</div></pre></td></tr></table></figure>
<p>现在CommentList有了data，让我们用data来动态渲染comments</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial10.js</span></div><div class="line"><span class="keyword">var</span> CommentList = React.createClass(&#123;</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> commentNodes = <span class="keyword">this</span>.props.data.map(<span class="function"><span class="keyword">function</span>(<span class="params">comment</span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> (</div><div class="line">        <span class="xml"><span class="tag">&lt;<span class="name">Comment</span> <span class="attr">author</span>=<span class="string">&#123;comment.author&#125;</span> <span class="attr">key</span>=<span class="string">&#123;comment.id&#125;</span>&gt;</span></span></div><div class="line">          &#123;comment.text&#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></div><div class="line">      );</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"commentList"</span>&gt;</span></span></div><div class="line">        &#123;commentNodes&#125;</div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="Domcom-9"><a href="#Domcom-9" class="headerlink" title="Domcom"></a>Domcom</h4><p>我们将commentList改成函数以便传递数据。利用each部件函数可以动态地监控数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentList</span>(<span class="params">comments</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> each(&#123;<span class="attr">className</span>: <span class="string">"commentList"</span>&#125;, comments, <span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> comment(item.author, item.text);</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在需要把commentList在commentBox的使用方式改为函数调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">      h1(<span class="string">"Comments"</span>),</div><div class="line">      makeCommentList(data),</div><div class="line">      commentForm</div><div class="line">    );</div></pre></td></tr></table></figure>
<p>在Domcom中并不需要层次化传递数据。我们这里并不一定要把commentBox改成部件函数。本教程会在后面的步骤中做这样的改变。是否这样做完全可以视应用需求而定，不是框架的要求。</p>
<h2 id="从服务器获取数据"><a href="#从服务器获取数据" class="headerlink" title="从服务器获取数据"></a>从服务器获取数据</h2><h4 id="React-10"><a href="#React-10" class="headerlink" title="React"></a>React</h4><p>让我们用从服务器动态获取的数据替换硬编码的数据。我们会删掉 data 属性，使用一个 URL 来获取数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial11.js</span></div><div class="line">ReactDOM.render(</div><div class="line">  <span class="xml"><span class="tag">&lt;<span class="name">CommentBox</span> <span class="attr">url</span>=<span class="string">"/api/comments"</span> /&gt;</span>,</span></div><div class="line">  document.getElementById('content')</div><div class="line">);</div></pre></td></tr></table></figure>
<h4 id="Domcom-10"><a href="#Domcom-10" class="headerlink" title="Domcom"></a>Domcom</h4><p>现在我们需要改变产生commentBox的方法。为了传入url参数，我们用函数产生部件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> commentBox = makeCommentBox(<span class="string">"/api/comments"</span>);</div><div class="line">commentBox.mount()</div></pre></td></tr></table></figure>
<h3 id="响应式状态（-Reactive-state-）"><a href="#响应式状态（-Reactive-state-）" class="headerlink" title="响应式状态（ Reactive state ）"></a>响应式状态（ Reactive state ）</h3><p>到目前为止，每一个组件都根据自己的 props 渲染了自己一次。 props 是不可变的：它们从父组件传递过来，“属于”父组件。为了实现交互，我们给组件引入了可变的 state 。this.state 是组件私有的，可以通过调用 this.setState() 来改变它。当 state 更新之后，组件就会重新渲染自己。</p>
<p>render() 方法依赖于 this.props 和 this.state ，框架会确保渲染出来的 UI 界面总是与输入（ this.props 和 this.state ）保持一致。</p>
<p>当服务器拿到评论数据的时候，我们将会用已知的评论数据改变评论。让我们给 CommentBox 组件添加一个评论数组作为它的 state ： </p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial12.js</span></div><div class="line"> <span class="keyword">var</span> CommentBox = React.createClass(&#123;</div><div class="line">   <span class="attr">getInitialState</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">     <span class="keyword">return</span> &#123;<span class="attr">data</span>: []&#125;;</div><div class="line">   &#125;,</div><div class="line">   <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">     <span class="keyword">return</span> (</div><div class="line">       <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"commentBox"</span>&gt;</span></span></div><div class="line">         <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Comments<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">CommentList</span> <span class="attr">data</span>=<span class="string">&#123;this.state.data&#125;</span> /&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">CommentForm</span> /&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">     );</div><div class="line">   &#125;</div><div class="line"> &#125;);</div></pre></td></tr></table></figure>
<h3 id="更新-state"><a href="#更新-state" class="headerlink" title="更新 state"></a>更新 state</h3><p>当组件第一次创建的时候，我们想从服务器获取（使用 GET 方法）一些 JSON 数据来更新状态，以便展示最新的数据。我们将会使用 jQuery 发送一个异步请求到我们之前启动好的服务器，获取我们需要的数据。数据格式看起来会是这个样子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;<span class="string">"author"</span>: <span class="string">"Pete Hunt"</span>, <span class="string">"text"</span>: <span class="string">"This is one comment"</span>&#125;,</div><div class="line">  &#123;<span class="string">"author"</span>: <span class="string">"Jordan Walke"</span>, <span class="string">"text"</span>: <span class="string">"This is *another* comment"</span>&#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>相应代码看起来是这个样子 </p>
<h4 id="React-11"><a href="#React-11" class="headerlink" title="React"></a>React</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial13.js</span></div><div class="line"><span class="keyword">var</span> CommentBox = React.createClass(&#123;</div><div class="line">  <span class="attr">getInitialState</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;<span class="attr">data</span>: []&#125;;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">componentDidMount</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="keyword">this</span>.props.url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">data</span>: data&#125;);</div><div class="line">      &#125;.bind(<span class="keyword">this</span>),</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="keyword">this</span>.props.url, status, err.toString());</div><div class="line">      &#125;.bind(<span class="keyword">this</span>)</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"commentBox"</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Comments<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">CommentList</span> <span class="attr">data</span>=<span class="string">&#123;this.state.data&#125;</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">CommentForm</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这个组件和前面的组件是不一样的，因为它必须重新渲染自己。在服务器请求返回之前，该组件将不会有任何数据，请求返回之后，该组件或许要渲染一些新的评论。</p>
<h4 id="Domcom-11"><a href="#Domcom-11" class="headerlink" title="Domcom"></a>Domcom</h4><p>根据现在的需求，我们把commentBox改成部件函数，把url作为参数传递。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentBox</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> comments = [];</div><div class="line">  <span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">      h1(<span class="string">"Comments"</span>),</div><div class="line">      makeCommentList(comments),</div><div class="line">      commentForm</div><div class="line">    );</div><div class="line">  commentBox.on(<span class="string">'didMount'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        comments.replaceAll(data);</div><div class="line">        dc.render();</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(url, status, err.toString());</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> commentBox;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码中，didMount事件的回调函数并不需要象在React的代码中那样引用this.props.url, 也不需要调用this.setState，只是使用函数参数url和局部变量comments，因此不需要把它设计为commentBox的方法，也不需要使用bind绑定this，用闭包函数就好了。</p>
<p>可以看到，Domcom中数据和部件解耦得更加彻底，同时传递和管理数据反而更加灵活便利了。</p>
<hr>
<h3 id="从服务器动态获取数据"><a href="#从服务器动态获取数据" class="headerlink" title="从服务器动态获取数据"></a>从服务器动态获取数据</h3><p>现在实现从服务器动态获取数据的代码。</p>
<p>这里， componentDidMount 是一个组件渲染的时候被 React 自动调用的方法。动态更新界面的关键点就是调用 this.setState() 。我们用新的从服务器拿到的评论数组来替换掉老的评论数组，然后 UI 自动更新。有了这种反应机制，实现实时更新就仅需要一小点改动。在这里我们使用简单的轮询，但是你也可以很容易地改为使用 WebSockets 或者其他技术。</p>
<h4 id="React-12"><a href="#React-12" class="headerlink" title="React"></a>React</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial14.js</span></div><div class="line"><span class="keyword">var</span> CommentBox = React.createClass(&#123;</div><div class="line">  <span class="attr">loadCommentsFromServer</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="keyword">this</span>.props.url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">data</span>: data&#125;);</div><div class="line">      &#125;.bind(<span class="keyword">this</span>),</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="keyword">this</span>.props.url, status, err.toString());</div><div class="line">      &#125;.bind(<span class="keyword">this</span>)</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">getInitialState</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;<span class="attr">data</span>: []&#125;;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">componentDidMount</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.loadCommentsFromServer();</div><div class="line">    setInterval(<span class="keyword">this</span>.loadCommentsFromServer, <span class="keyword">this</span>.props.pollInterval);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div className="commentBox"&gt;</div><div class="line">        &lt;h1&gt;Comments&lt;/h1&gt;</div><div class="line">        &lt;CommentList data=&#123;this.state.data&#125; /&gt;</div><div class="line">        &lt;CommentForm /&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">ReactDOM.render(</div><div class="line">  &lt;CommentBox url="/api/comments" pollInterval=&#123;2000&#125; /&gt;,</div><div class="line">  document.getElementById('content')</div><div class="line">);</div></pre></td></tr></table></figure>
<h4 id="Domcom-12"><a href="#Domcom-12" class="headerlink" title="Domcom"></a>Domcom</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"> function makeCommentBox(url = “api/comments”, pollInterval = 2000) &#123;</div><div class="line">   const comments = [];</div><div class="line">   const commentBox = div(&#123;className: "commentBox"&#125;, </div><div class="line">       h1("Comments"),</div><div class="line">       makeCommentList(comments),</div><div class="line">       commentForm</div><div class="line">   );</div><div class="line">   </div><div class="line">   function loadCommentsFromServer() &#123;</div><div class="line">     $.ajax(&#123;</div><div class="line">       url: url,</div><div class="line">       dataType: 'json',</div><div class="line">       cache: false,</div><div class="line">       success: function(data) &#123;</div><div class="line">         comments.replaceAll(data);</div><div class="line">         dc.render();</div><div class="line">       &#125;,</div><div class="line">       error: function(xhr, status, err) &#123;</div><div class="line">         console.error(url, status, err.toString());</div><div class="line">       &#125;</div><div class="line">     &#125;);</div><div class="line">   &#125;,</div><div class="line">     </div><div class="line">   commentBox.on('didMount', function()&#123;</div><div class="line">     loadCommentsFromServer();</div><div class="line">     setInterval(loadCommentsFromServer, pollInterval)</div><div class="line">   &#125;);</div><div class="line">   </div><div class="line">   return commentBox;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码中，我们将有关代码重构为loadCommentsFromServer，因为与前一个步骤类似的理由，依然只要用闭包函数就好，不必将其设定为commentBox的方法。    </p>
<hr>
<h2 id="添加新的评论"><a href="#添加新的评论" class="headerlink" title="添加新的评论"></a>添加新的评论</h2><p>现在是时候构造表单了。我们的 CommentForm 组件应该询问用户的名字和评论内容，然后发送一个请求到服务器，保存这条评论。</p>
<h4 id="React-13"><a href="#React-13" class="headerlink" title="React"></a>React</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial15.js</span></div><div class="line"><span class="keyword">var</span> CommentForm = React.createClass(&#123;</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;form className="commentForm"&gt;</div><div class="line">        &lt;input type="text" placeholder="Your name" /&gt;</div><div class="line">        &lt;input type="text" placeholder="Say something..." /&gt;</div><div class="line">        &lt;input type="submit" value="Post" /&gt;</div><div class="line">      &lt;/form&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="Domcom-13"><a href="#Domcom-13" class="headerlink" title="Domcom"></a>Domcom</h4><p>考虑到后面有传递回调函数参数的需求，现在就直接将commentForm改为用函数实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentForm</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> form(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">    text(&#123;<span class="attr">placeholder</span>: <span class="string">"Your name"</span>&#125;),</div><div class="line">    text(&#123;<span class="attr">placeholder</span>: <span class="string">"Say something..."</span>&#125;),</div><div class="line">    input(&#123;<span class="attr">type</span>: <span class="string">"submit"</span>, <span class="attr">value</span>: <span class="string">"Post"</span>&#125;)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="处理输入事件"><a href="#处理输入事件" class="headerlink" title="处理输入事件"></a>处理输入事件</h3><h4 id="React-14"><a href="#React-14" class="headerlink" title="React"></a>React</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial16.js</span></div><div class="line"><span class="keyword">var</span> CommentForm = React.createClass(&#123;</div><div class="line">  <span class="attr">getInitialState</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">handleAuthorChange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">author</span>: e.target.value&#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">handleTextChange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">text</span>: e.target.value&#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;form className="commentForm"&gt;</div><div class="line">        &lt;input</div><div class="line">          type="text"</div><div class="line">          placeholder="Your name"</div><div class="line">          value=&#123;this.state.author&#125;</div><div class="line">          onChange=&#123;this.handleAuthorChange&#125;</div><div class="line">        /&gt;</div><div class="line">        &lt;input</div><div class="line">          type="text"</div><div class="line">          placeholder="Say something..."</div><div class="line">          value=&#123;this.state.text&#125;</div><div class="line">          onChange=&#123;this.handleTextChange&#125;</div><div class="line">        /&gt;</div><div class="line">        &lt;input type="submit" value="Post" /&gt;</div><div class="line">      &lt;/form&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h4><p>React 使用驼峰命名规范的方式给组件绑定事件处理器。我们给表单绑定一个onSubmit处理器，用于当表单提交了合法的输入后清空表单字段。</p>
<p>用回调函数作为属性（ props ）<br>当用户提交评论的时候，我们需要刷新评论列表来加进这条新评论。在 CommentBox 中完成所有逻辑是合适的，因为 CommentBox 拥有代表评论列表的状态（ state ）。</p>
<p>我们需要从子组件传数据到它的父组件。我们在父组件的 render 方法中这样做：传递一个新的回调函数（ handleCommentSubmit ）到子组件，绑定它到子组件的 onCommentSubmit 事件上。无论事件什么时候触发，回调函数都会被调用：</p>
<h4 id="Domcom-14"><a href="#Domcom-14" class="headerlink" title="Domcom"></a>Domcom</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentForm</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> newComment = &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  <span class="keyword">return</span> form(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Your name"</span>,</div><div class="line">      <span class="attr">value</span>: newComment.author,</div><div class="line">      <span class="attr">onchange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.author = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Say something..."</span>,</div><div class="line">      <span class="attr">value</span>: newComment.text,</div><div class="line">      <span class="attr">onchange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.text = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    input(&#123;<span class="attr">type</span>: <span class="string">"submit"</span>, <span class="attr">value</span>: <span class="string">"Post"</span>&#125;)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码中，除了text部件，没有别的地方会改变newComment的内容，text部件不需要依据newComment动态刷新。如果需要text部件自动响应newComment的数据变化，可以使用响应函数, 这里可以用flow.bind, 就象这样：<code>text({..., value: flow.bind(newComment, &#39;author&#39;), ...})</code>。</p>
<p>如果使用指令，上面的代码可以更加简化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">dc.directives(<span class="string">'model'</span>, dc.$model);    </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentForm</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> newComment = &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  <span class="keyword">const</span> &#123;author$, text$&#125; = dc.bindings(newComment);</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> form(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Your name"</span>,</div><div class="line">      <span class="attr">$model</span>: author$</div><div class="line">    &#125;),</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Say something..."</span>,</div><div class="line">      <span class="attr">$model</span>: text$</div><div class="line">    &#125;),</div><div class="line">    input(&#123;<span class="attr">type</span>: <span class="string">"submit"</span>, <span class="attr">value</span>: <span class="string">"Post"</span>&#125;)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>text部件（也包括其它input部件）甚至可以这样写：<code>text({ placeholder: &quot;Your name&quot;}， author$)</code>。这种写法和使用指令的写法都只是不同程度的语法糖而已，本质上和不用指令的代码是一样的。</p>
<hr>
<h3 id="表单交互"><a href="#表单交互" class="headerlink" title="表单交互"></a>表单交互</h3><p>让我们使表单可交互。当用户提交表单的时候，我们应该清空表单，发送一个请求到服务器，然后刷新评论列表。首先，让我们监听表单的提交事件，然后清空表单。</p>
<h4 id="React-15"><a href="#React-15" class="headerlink" title="React"></a>React</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial17.js</span></div><div class="line"><span class="keyword">var</span> CommentForm = React.createClass(&#123;</div><div class="line">  <span class="attr">getInitialState</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">handleAuthorChange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">author</span>: e.target.value&#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">handleTextChange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">text</span>: e.target.value&#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">handleSubmit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    e.preventDefault();</div><div class="line">    <span class="keyword">var</span> author = <span class="keyword">this</span>.state.author.trim();</div><div class="line">    <span class="keyword">var</span> text = <span class="keyword">this</span>.state.text.trim();</div><div class="line">    <span class="keyword">if</span> (!text || !author) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> send request to the server</span></div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;form className="commentForm" onSubmit=&#123;this.handleSubmit&#125;&gt;</div><div class="line">        &lt;input</div><div class="line">          type="text"</div><div class="line">          placeholder="Your name"</div><div class="line">          value=&#123;this.state.author&#125;</div><div class="line">          onChange=&#123;this.handleAuthorChange&#125;</div><div class="line">        /&gt;</div><div class="line">        &lt;input</div><div class="line">          type="text"</div><div class="line">          placeholder="Say something..."</div><div class="line">          value=&#123;this.state.text&#125;</div><div class="line">          onChange=&#123;this.handleTextChange&#125;</div><div class="line">        /&gt;</div><div class="line">        &lt;input type="submit" value="Post" /&gt;</div><div class="line">      &lt;/form&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="Domcom-15"><a href="#Domcom-15" class="headerlink" title="Domcom"></a>Domcom</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentForm</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> newComment = &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  <span class="keyword">return</span> form(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Your name"</span>,</div><div class="line">      <span class="attr">value</span>: newComment.author,</div><div class="line">      <span class="attr">onchange</span>:<span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.author = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Say something..."</span>,</div><div class="line">      <span class="attr">value</span>: newComment.text,</div><div class="line">      <span class="attr">onchange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.text = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    input(&#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">"submit"</span>, </div><div class="line">      <span class="attr">value</span>: <span class="string">"Post"</span>,</div><div class="line">      <span class="attr">onsubmit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>) </span>&#123;</div><div class="line">        event.preventDefault = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">var</span> author = newComment.author.trim();</div><div class="line">        <span class="keyword">var</span> text = newComment.text.trim();</div><div class="line">        <span class="keyword">if</span> (!text || !author) &#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        extend(newComment, &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;);</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> send request to the server</span></div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>当用户提交表单的时候，在 CommentForm 中调用这个回调函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">// tutorial18.js</span></div><div class="line">    <span class="keyword">var</span> CommentBox = React.createClass(&#123;</div><div class="line">      <span class="attr">loadCommentsFromServer</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        $.ajax(&#123;</div><div class="line">          <span class="attr">url</span>: <span class="keyword">this</span>.props.url,</div><div class="line">          <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">          <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">          <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">            <span class="keyword">this</span>.setState(&#123;<span class="attr">data</span>: data&#125;);</div><div class="line">          &#125;.bind(<span class="keyword">this</span>),</div><div class="line">          <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.error(<span class="keyword">this</span>.props.url, status, err.toString());</div><div class="line">          &#125;.bind(<span class="keyword">this</span>)</div><div class="line">        &#125;);</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">handleCommentSubmit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">comment</span>) </span>&#123;</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> submit to the server and refresh the list</span></div><div class="line">      &#125;,</div><div class="line">      <span class="attr">getInitialState</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> &#123;<span class="attr">data</span>: []&#125;;</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">componentDidMount</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.loadCommentsFromServer();</div><div class="line">        setInterval(<span class="keyword">this</span>.loadCommentsFromServer, <span class="keyword">this</span>.props.pollInterval);</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">          &lt;div className="commentBox"&gt;</div><div class="line">            &lt;h1&gt;Comments&lt;/h1&gt;</div><div class="line">            &lt;CommentList data=&#123;this.state.data&#125; /&gt;</div><div class="line">            &lt;CommentForm onCommentSubmit=&#123;this.handleCommentSubmit&#125; /&gt;</div><div class="line">          &lt;/div&gt;</div><div class="line">        );</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">```    </div><div class="line">    </div><div class="line">#### Domcom</div><div class="line"></div><div class="line">现在修改makeCommentBox，向makeCommentForm传递一个回调函数作为参数以便处理提交数据。</div><div class="line"></div><div class="line">```js</div><div class="line">    function makeCommentBox(url, pollInterval = 2000) &#123;</div><div class="line">      const comments = [];</div><div class="line">      const commentBox = div(&#123;className: "commentBox"&#125;, </div><div class="line">          h1("Comments"),</div><div class="line">          makeCommentList(comments),</div><div class="line">          makeCommentForm(function(newComment)&#123;</div><div class="line">            // TODO: submit to the server and refresh the list</div><div class="line">          &#125;)</div><div class="line">      );</div><div class="line">      </div><div class="line">      function loadCommentsFromServer() &#123;</div><div class="line">        $.ajax(&#123;</div><div class="line">          url: url,</div><div class="line">          dataType: 'json',</div><div class="line">          cache: false,</div><div class="line">          success: function(data) &#123;</div><div class="line">            comments.replaceAll(data);</div><div class="line">            dc.render();</div><div class="line">          &#125;,</div><div class="line">          error: function(xhr, status, err) &#123;</div><div class="line">            console.error(url, status, err.toString());</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">      &#125;,</div><div class="line">        </div><div class="line">      commentBox.on('didMount', function()&#123;</div><div class="line">        loadCommentsFromServer();</div><div class="line">        setInterval(loadCommentsFromServer, pollInterval)</div><div class="line">      &#125;);</div><div class="line">      </div><div class="line">      return commentBox;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="调用回调并清除评论"><a href="#调用回调并清除评论" class="headerlink" title="调用回调并清除评论"></a>调用回调并清除评论</h3><h4 id="React-16"><a href="#React-16" class="headerlink" title="React"></a>React</h4><p>既然CommentBox已经通过onCommentSubmit特性将回调函数传递给CommentForm，CommentForm应该在用户提交form的时候调用这个回调函数。调用之后记得清除已经提交的评论。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial19.js</span></div><div class="line"><span class="keyword">var</span> CommentForm = React.createClass(&#123;</div><div class="line">  <span class="attr">getInitialState</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">handleAuthorChange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">author</span>: e.target.value&#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">handleTextChange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">text</span>: e.target.value&#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">handleSubmit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    e.preventDefault();</div><div class="line">    <span class="keyword">var</span> author = <span class="keyword">this</span>.state.author.trim();</div><div class="line">    <span class="keyword">var</span> text = <span class="keyword">this</span>.state.text.trim();</div><div class="line">    <span class="keyword">if</span> (!text || !author) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.props.onCommentSubmit(&#123;<span class="attr">author</span>: author, <span class="attr">text</span>: text&#125;);</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;form className="commentForm" onSubmit=&#123;this.handleSubmit&#125;&gt;</div><div class="line">        &lt;input</div><div class="line">          type="text"</div><div class="line">          placeholder="Your name"</div><div class="line">          value=&#123;this.state.author&#125;</div><div class="line">          onChange=&#123;this.handleAuthorChange&#125;</div><div class="line">        /&gt;</div><div class="line">        &lt;input</div><div class="line">          type="text"</div><div class="line">          placeholder="Say something..."</div><div class="line">          value=&#123;this.state.text&#125;</div><div class="line">          onChange=&#123;this.handleTextChange&#125;</div><div class="line">        /&gt;</div><div class="line">        &lt;input type="submit" value="Post" /&gt;</div><div class="line">      &lt;/form&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="Domcom-16"><a href="#Domcom-16" class="headerlink" title="Domcom"></a>Domcom</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentForm</span>(<span class="params">submitComment</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> newComment = &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  <span class="keyword">return</span> form(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Your name"</span>,</div><div class="line">      <span class="attr">value</span>: newComment.author,</div><div class="line">      <span class="attr">onchange</span>:<span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.author = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Say something..."</span>,</div><div class="line">      <span class="attr">value</span>: newComment.text,</div><div class="line">      <span class="attr">onchange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.text = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    input(&#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">"submit"</span>, </div><div class="line">      <span class="attr">value</span>: <span class="string">"Post"</span>,</div><div class="line">      <span class="attr">onsubmit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>) </span>&#123;</div><div class="line">        event.preventDefault = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">var</span> author = newComment.author.trim();</div><div class="line">        <span class="keyword">var</span> text = newComment.text.trim();</div><div class="line">        <span class="keyword">if</span> (!text || !author) &#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        submitComment(newComment);</div><div class="line">        extend(newComment, &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;);</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="发起POST请求并更新状态"><a href="#发起POST请求并更新状态" class="headerlink" title="发起POST请求并更新状态"></a>发起POST请求并更新状态</h3><h4 id="React-17"><a href="#React-17" class="headerlink" title="React"></a>React</h4><p>在传递给CommentForm的回调handleCommentSubmit中添加ajax代码，发起服务器POST请求，成功时调用setState更新状态。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial20.js</span></div><div class="line"><span class="keyword">var</span> CommentBox = React.createClass(&#123;</div><div class="line">  <span class="attr">loadCommentsFromServer</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="keyword">this</span>.props.url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">data</span>: data&#125;);</div><div class="line">      &#125;.bind(<span class="keyword">this</span>),</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="keyword">this</span>.props.url, status, err.toString());</div><div class="line">      &#125;.bind(<span class="keyword">this</span>)</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">handleCommentSubmit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">comment</span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="keyword">this</span>.props.url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">type</span>: <span class="string">'POST'</span>,</div><div class="line">      <span class="attr">data</span>: comment,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">data</span>: data&#125;);</div><div class="line">      &#125;.bind(<span class="keyword">this</span>),</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="keyword">this</span>.props.url, status, err.toString());</div><div class="line">      &#125;.bind(<span class="keyword">this</span>)</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">getInitialState</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;<span class="attr">data</span>: []&#125;;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">componentDidMount</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.loadCommentsFromServer();</div><div class="line">    setInterval(<span class="keyword">this</span>.loadCommentsFromServer, <span class="keyword">this</span>.props.pollInterval);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div className="commentBox"&gt;</div><div class="line">        &lt;h1&gt;Comments&lt;/h1&gt;</div><div class="line">        &lt;CommentList data=&#123;this.state.data&#125; /&gt;</div><div class="line">        &lt;CommentForm onCommentSubmit=&#123;this.handleCommentSubmit&#125; /&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="Domcom-17"><a href="#Domcom-17" class="headerlink" title="Domcom"></a>Domcom</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentBox</span>(<span class="params">url, pollInterval = <span class="number">2000</span></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> comments = [];</div><div class="line">  <span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">      h1(<span class="string">"Comments"</span>),</div><div class="line">      makeCommentList(comments),</div><div class="line">      makeCommentForm(<span class="function"><span class="keyword">function</span>(<span class="params">newComment</span>)</span>&#123;</div><div class="line">        $.ajax(&#123;</div><div class="line">          <span class="attr">url</span>: url,</div><div class="line">          <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">          <span class="attr">type</span>: <span class="string">'POST'</span>,</div><div class="line">          <span class="attr">data</span>: newComment,</div><div class="line">          <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">            comments.replaceAll(data);</div><div class="line">            dc.render();</div><div class="line">          &#125;,</div><div class="line">          <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.error(<span class="keyword">this</span>.props.url, status, err.toString());</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">      &#125;)</div><div class="line">  );</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadCommentsFromServer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        comments.replaceAll(data);</div><div class="line">        dc.render();</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(url, status, err.toString());</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">    </div><div class="line">  commentBox.on(<span class="string">'didMount'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    loadCommentsFromServer();</div><div class="line">    setInterval(loadCommentsFromServer, pollInterval)</div><div class="line">  &#125;);</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> commentBox;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="优化：提前更新"><a href="#优化：提前更新" class="headerlink" title="优化：提前更新"></a>优化：提前更新</h2><p>我们的应用现在已经完成了所有功能，但是在新添加的评论出现在列表之前，必须等待请求完成，所以感觉很慢。我们可以直接添加这条评论到列表中，从而使应用感觉更快。</p>
<h4 id="React-18"><a href="#React-18" class="headerlink" title="React"></a>React</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// tutorial21.js</span></div><div class="line"><span class="keyword">var</span> CommentBox = React.createClass(&#123;</div><div class="line">  <span class="attr">loadCommentsFromServer</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="keyword">this</span>.props.url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">data</span>: data&#125;);</div><div class="line">      &#125;.bind(<span class="keyword">this</span>),</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="keyword">this</span>.props.url, status, err.toString());</div><div class="line">      &#125;.bind(<span class="keyword">this</span>)</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">handleCommentSubmit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">comment</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> comments = <span class="keyword">this</span>.state.data;</div><div class="line">    <span class="comment">// Optimistically set an id on the new comment. It will be replaced by an</span></div><div class="line">    <span class="comment">// id generated by the server. In a production application you would likely</span></div><div class="line">    <span class="comment">// not use Date.now() for this and would have a more robust system in place.</span></div><div class="line">    comment.id = <span class="built_in">Date</span>.now();</div><div class="line">    <span class="keyword">var</span> newComments = comments.concat([comment]);</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">data</span>: newComments&#125;);</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: <span class="keyword">this</span>.props.url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">type</span>: <span class="string">'POST'</span>,</div><div class="line">      <span class="attr">data</span>: comment,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">data</span>: data&#125;);</div><div class="line">      &#125;.bind(<span class="keyword">this</span>),</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">data</span>: comments&#125;);</div><div class="line">        <span class="built_in">console</span>.error(<span class="keyword">this</span>.props.url, status, err.toString());</div><div class="line">      &#125;.bind(<span class="keyword">this</span>)</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">getInitialState</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;<span class="attr">data</span>: []&#125;;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">componentDidMount</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.loadCommentsFromServer();</div><div class="line">    setInterval(<span class="keyword">this</span>.loadCommentsFromServer, <span class="keyword">this</span>.props.pollInterval);</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div className="commentBox"&gt;</div><div class="line">        &lt;h1&gt;Comments&lt;/h1&gt;</div><div class="line">        &lt;CommentList data=&#123;this.state.data&#125; /&gt;</div><div class="line">        &lt;CommentForm onCommentSubmit=&#123;this.handleCommentSubmit&#125; /&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="Domcom-18"><a href="#Domcom-18" class="headerlink" title="Domcom"></a>Domcom</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentBox</span>(<span class="params">url, pollInterval = <span class="number">2000</span></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> comments = [];</div><div class="line">  <span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">      h1(<span class="string">"Comments"</span>),</div><div class="line">      makeCommentList(comments),</div><div class="line">      makeCommentForm(<span class="function"><span class="keyword">function</span>(<span class="params">newComment</span>)</span>&#123;            </div><div class="line">        $.ajax(&#123;</div><div class="line">          <span class="attr">url</span>: url,</div><div class="line">          <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">          <span class="attr">type</span>: <span class="string">'POST'</span>,</div><div class="line">          <span class="attr">data</span>: newComment,</div><div class="line">          <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">            comments.replaceAll(data);</div><div class="line">            dc.render();</div><div class="line">          &#125;,</div><div class="line">          <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.error(url, status, err.toString());</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">        comments.push(newComment);</div><div class="line">        commentBox.render();</div><div class="line">      &#125;)</div><div class="line">  );</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadCommentsFromServer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        comments.replaceAll(data);</div><div class="line">        dc.render();</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(url, status, err.toString());</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">    </div><div class="line">  commentBox.on(<span class="string">'didMount'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    loadCommentsFromServer();</div><div class="line">    setInterval(loadCommentsFromServer, pollInterval);</div><div class="line">  &#125;);</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> commentBox;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>从上述分别用React和Domcom通过一些步骤构造评论框的过程，我们看到Domcom的代码比React要简洁很多（即使比带JSX的React代码也更简洁)，涉及的新概念也更少，学习曲线更低，更加贴近javascript最普遍的语言特性。而且我可以告诉大家，Domcom的实现原理可以让它达到比React更好的运行性能。</p>
<p>考虑到当前web前端的主流习惯，本文以javascript作为Domcom演示语言。Domcom框架是以用coffee-script开发的，但从使用上可以良好地用在ES6或ES5环境中，并且以UMD风格支持模块化。如果使用coffee-script语言来开发Domcom的应用程序，代码将更为简洁优雅。</p>
<blockquote>
<p>对于React框架而言，不用JSX的话代码会繁琐得多。以React如此繁琐的API，让程序员不用JSX显然是难以令人接受的。我想，React设计者不遗余力地实现JSX，应该有减少这种繁琐的意图。然而，即使用JSX写React依然是很繁琐的。比如说生命周期方法的名称为什么要那么长？明显可以用更简短的名字。还有类似this.props.data，this.props.children之类的长串访问路径, 以及refs的设计，事件处理方法需要bind this，等等。这些用起来都是很不方便的。</p>
<p>既然reactJS的设计者意识到了程序员是讨厌繁琐的，为什么要设计如此繁琐的API？我只能理解为React设计者的观念问题。设计者已经理解到了完全由javascript掌控页面，将页面组件化的优势和重要性，这是一个巨大的进步。然而，遗憾的是React设计者的观念没有能在API和语法习惯上转过弯来，还停留在实现框架初期的当时状态，不由自主地向html页面设计者做出了妥协。其实，为了实现这种妥协反而需要付出更大的努力去实现JSX的编译器，这个难度远远超过设计简洁API的难度。然而，既然React应用的页面构造已经完全在javascript代码和程序员的掌控之下，这样一种妥协就是完全不必要和不适当的，徒增学习难度、工具复杂度，降低开发效率，带来更多问题。</p>
<p>除了API的繁琐外，ReactJS在观念与设计哲学上与Javascript上存在很多不协调之处，比如：对副作用不够友好，为了粉饰这个缺陷而过分地拔高函数式编程，贬低OOP，用flux取代MVVM或者MVC等到，结果是导致了ReactJS全家桶的现象。</p>
<p>基于上述原因，虽然我最初就看到了ReactJS整体上带来的的进步，但是也看到了ReactJS将带来的巨大问题，可以认为，ReactJS有如此多的痛点，并不是一个非常完善的框架。这也是促使我设计Domcom的原因之一。</p>
<p>由此观之，开发者的整体观念和理念是多么重要啊。它不但影响了一个框架，又进一步影响到了一个应用领域。不象Java社区，Javascript社区是不太喜欢笨重的xml风格的，而是更加青睐类似JSON这种更简单轻便的规范。不过，作为web前端开发者，在以前的开发模式下，总是不可避免地要和Html打交道的。React本来很有希望能够进一步统一web前端开发的代码风格，逼近非web领域的主流GUI开发方式。因为观念的原因，很遗憾React错过了这个机会，让Domcom能有机会站在巨人的肩膀上。  </p>
</blockquote>
<p>关于React和Domcom的总体对比，<a href="https://taijiweb.github.io/2016/08/05/domcom%E6%AF%94ReactJS%E5%A5%BD%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F" target="_blank" rel="external">这篇文章</a>有更深入的阐述。</p>
<hr>
<p>祝贺你你刚刚通过一些简单步骤构造了一个评论框。现在你可以去学习一个<a href="https://github.com/taijiweb/domcom/blob/master/doc/Chinese/%E4%BB%8B%E7%BB%8D%E5%92%8C%E8%BE%85%E5%AF%BC%E6%95%99%E7%A8%8B.md">更全面的辅导教程</a>, 了解更多关于<a href="https://github.com/taijiweb/domcom/blob/master/doc/Chinese/%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86.md"> Domcom 的概念和原理</a>，或者去看看 <a href="https://github.com/taijiweb/domcom/blob/master/doc/Chinese/API%E5%8F%82%E8%80%83.md">Domcomm API参考</a>。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://github.com/taijiweb/2016/08/09/从React教程学Domcom/" data-id="ciu0utlef0006d9bh9exwu234" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Domcom/">Domcom</a><a href="/tags/framework/">framework</a><a href="/tags/javascript/">javascript</a></div><div class="post-nav"><a href="/2016/08/26/前端简史演义/" class="pre">前端演义</a><a href="/2016/08/08/从实例看React与Domcom/" class="next">React与Domcom面对面 -- 一些代码对比</a></div><div data-thread-key="2016/08/09/从React教程学Domcom/" data-title="React 与 Domcom 面对面 -- 评论框教程" data-url="http://github.com/taijiweb/2016/08/09/从React教程学Domcom/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/08/09/从React教程学Domcom/" data-title="React 与 Domcom 面对面 -- 评论框教程" data-url="http://github.com/taijiweb/2016/08/09/从React教程学Domcom/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://github.com/taijiweb"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Domcom/">Domcom</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Domcom/" style="font-size: 15px;">Domcom</a> <a href="/tags/framework/" style="font-size: 15px;">framework</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/07/有了rewrap，老板再也不担心我的正则了/">有了rewrap，老板再也不担心我的正则了</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/28/Domcom评论框教程/">Domcom评论框教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/26/前端简史演义/">前端演义</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/09/从React教程学Domcom/">React 与 Domcom 面对面 -- 评论框教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/08/从实例看React与Domcom/">React与Domcom面对面 -- 一些代码对比</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/05/domcom比ReactJS好在哪里？/">React与Domcom面对面 -- domcom 好在哪里？</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/29/框架的演进/">前端编程方法和框架的演进</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/28/hello-world/">taijweb's blog</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.github.com/taijiweb" title="taijiweb's github" target="_blank">taijiweb's github</a><ul></ul><a href="http://www.github.com/chaosim" title="chaosim's github" target="_blank">chaosim's github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">taijiweb's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'taijiweb'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>