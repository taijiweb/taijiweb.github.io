<!DOCTYPE html><html lang="zh-CN,en,default"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Domcom评论框教程 | taijiweb's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Domcom评论框教程</h1><a id="logo" href="/.">taijiweb's blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Domcom评论框教程</h1><div class="post-meta">Aug 28, 2016<span> | </span><span class="category"><a href="/categories/Domcom/">Domcom</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/08/28/Domcom评论框教程/" href="/2016/08/28/Domcom评论框教程/#comments" class="ds-thread-count"></a><div class="post-content"><p>本文依据<a href="https://facebook.github.io/react/docs/tutorial.html" target="_blank" rel="external">React的评论框教程</a>写成。案例本身以及不少中文解说文字出自<a href="http://reactjs.cn/react/index.html" target="_blank" rel="external">React 中文社区对React Tutorial的翻译</a>，略有改动。其余部分为本人原创。上述相关方以及各位读者如果觉得本文有侵权或其它不妥之处，敬请告知taijiweeb@gmail.com，本人将做适当修改，谢谢。</p>
<h2 id="构造一个评论部件"><a href="#构造一个评论部件" class="headerlink" title="构造一个评论部件"></a>构造一个评论部件</h2><p>我们将构建一个简单却真实的评论框，你可以将它放入你的博客，类似于 disqus 、 livefyre 、 facebook 中实时评论框，包含一些基础功能。我们将提供以下功能：</p>
<ul>
<li>展示所有评论的界面</li>
<li>发布评论的表单</li>
<li>后端 API 接口地址，该接口需要自己实现 </li>
</ul>
<p>同时也包含一些简洁的特性：</p>
<ul>
<li>发布评论的体验优化： 评论在保存到服务器之前就展现在评论列表，因此感觉起来很快。</li>
<li>实时更新： 其他用户的评论将会实时展示在评论框中。</li>
<li>Markdown格式： 用户可以使用Markdown语法来编辑评论文本。</li>
</ul>
<hr>
<h2 id="运行一个服务器"><a href="#运行一个服务器" class="headerlink" title="运行一个服务器"></a>运行一个服务器</h2><p>为了开始本教程，我们将需要一个运行的服务器，提供一个 API 接口，仅用于获取和保存评论数据。为了尽量简便，我们已经准备好了几种脚本语言开发的简单服务器程序，完成了我们需要的功能。你可以查看<a href="https://github.com/taijiweb/domcom-tutorial">源码</a>或者<a href="https://github.com/taijiweb/domcom-tutorial/archive/master.zip">下载 zip 文件</a>，里面包含了开始学习教程所需的所有东西。</p>
<p>为了简单，服务器将会使用一个 JSON 文件作为数据库。不能在生产环境中采用这种做法，但是这样做确实简化了模拟后端 API 的工作。一旦启动了这个服务器，它就能提供我们需要的 API 接口，同时也能生成并发送我们需要的页面。</p>
<hr>
<h2 id="设置html页面"><a href="#设置html页面" class="headerlink" title="设置html页面"></a>设置html页面</h2><p>本教程会尽量简单。上述讨论提及的页面是一个 HTML 文件，它包含在服务器源码包中，我们先看看这个文件。使用你最喜欢的编辑器打开 public/index.html ，然后会看见这些内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- index.html --&gt;</span></div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Domcom Tutorial<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.jsdelivr.net/domcom/0.5.2/domcom.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://npmcdn.com/jquery@3.1.0/dist/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- domcom 可以很方便地使用 ES5 原生代码来编写，不需要包含babel --&gt;</span></div><div class="line">    <span class="comment">&lt;!-- script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"&gt;&lt;/script --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://npmcdn.com/remarkable@1.6.2/dist/remarkable.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"scripts/example.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="xml"></span></div><div class="line">      // 在本教程的剩下部分，我们会在这个 script 标签中编写我们的 JavaScript 代码。</div><div class="line">      // 我们没有任何高端的页面自动加载刷新工具，所以在修改了代码之后，需要手动刷新浏览器来查看变化。</div><div class="line">      // 下面，启动服务器，在浏览器中打开 http://localhost:3000 。</div><div class="line">      // 在没对源码进行修改的前提下，第一次打开这个 URL 会看到我们计划构建的应用的一个最终样子。</div><div class="line">      // 当你完成本教程，需要使用外部javascript文件的时候，只需要删掉这个 `<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">` 标签就可以了。</span></div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>因为Domcom所有的api都在dc名字空间上，因此使用dc本身不要求使用babel之类的工具。本教程的Domcom代码仅使用了两项ES6特征：解构赋值和const关键词。因此只要把解构赋值语句用ES5语法重写，将const关键词用var替换，代码即已经符合ES5标准。当然，使用ES6会让代码更简洁一些，使用babel预编译还是鼓励的。</p>
<blockquote>
<p>为行文方便，文中涉及的dc名字空间的API名称并没有一一声明和导入。这些名字包括div, span, h1, h2, input, text, html, $model, flow(flow.bind, flow.bindings)等。实际编码时需要根据ES6或ES5的不同语法加以处理。请留意。</p>
</blockquote>
<p><strong>注意</strong></p>
<blockquote>
<p>因为我们想简化 ajax 请求代码，所以在这里引入 jQuery，但是 Domcom 并不依赖于<strong>任何其它库</strong>，也包括 jQuery 。</p>
</blockquote>
<hr>
<h2 id="第一个部件"><a href="#第一个部件" class="headerlink" title="第一个部件"></a>第一个部件</h2><h4 id="Domcom"><a href="#Domcom" class="headerlink" title="Domcom"></a>Domcom</h4><p>Domcom是基于部件的框架。所有部件都是模块化，可组装的，组合性以及扩展性都非常好。另外还有一个显著特点，Domcom部件支持通过OOP方式进行扩展。</p>
<blockquote>
<p>可以看到，本教程中Domcom表现得非常贴近函数式编程，没有体现出任何与OOP有关的特征，因此必须在这里特别地强调OOP的重要性。在GUI领域，OOP是非常重要的。只要熟悉GUI编程（比如MFC，WPF，Qt，WxWidgets, Android UI，cocoa等等）的人都应该理解这一点，不被某些错误的言论误导。</p>
</blockquote>
<p>对于我们的评论框例子，我们将有如下的 Domcom 部件结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- CommentBox  </div><div class="line">  - CommentList  </div><div class="line">    - Comment  </div><div class="line">  - CommentForm</div></pre></td></tr></table></figure>
<p>第一步只是构造一个简单的div。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123;div&#125; = dc;</div><div class="line"><span class="keyword">var</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">  <span class="string">"Hello, world! I am a CommentBox."</span></div><div class="line">);</div><div class="line">commentBox.mount();</div></pre></td></tr></table></figure>
<hr>
<h2 id="制作部件"><a href="#制作部件" class="headerlink" title="制作部件"></a>制作部件</h2><p>让我们为 commentList 和 commentForm 搭建骨架，它们也是由一些简单的 <code>&lt;div&gt;</code> 组成。将这两个部件的代码添加到你的源码文件中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123;div&#125; = dc;</div><div class="line"><span class="keyword">const</span> commentList = div(&#123;<span class="attr">className</span>: <span class="string">"commentList"</span>&#125;,</div><div class="line">        <span class="string">"Hello, world! I am a CommentList."</span></div><div class="line">);</div><div class="line"><span class="keyword">const</span> CommentForm = div(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">        <span class="string">"Hello, world! I am a commentForm."</span></div><div class="line">);</div></pre></td></tr></table></figure>
<p>接下来，使用新创建的部件更新 commentBox 部件代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">  h1(<span class="string">"Comments"</span>),</div><div class="line">  commentList,</div><div class="line">  commentForm</div><div class="line">);</div></pre></td></tr></table></figure>
<hr>
<h2 id="传递数据"><a href="#传递数据" class="headerlink" title="传递数据"></a>传递数据</h2><p>Domcom中可以直接通过函数参数传递数据。 </p>
<p>对于AngularJS，ReactJS的数据传递机制（AngularJS是耦合于Scope的层次，ReactJS是耦合于组件的props和state层次），我联想到TJ Holowaychuk关于AngularJS模块设计机制的疑问：Why not just require？类似地，为什么不简单地利用函数及其参数来传递数据呢？这难道不是各种编程语言都提供的最普遍最自然的构造吗？Domcom正是充分利用这种方法实现了更好的数据传递与数据管理，实现了view和controllor以及model之间更充分的解耦，消除了层次化耦合数据这一重大的限制，从而实现了更灵活、更强大、解耦更彻底的数据传递和数据管理，能更好地支持MVC、MVVM或者flux等设计模式。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">function makeComment(author, content) &#123;</div><div class="line">  return div(&#123;className: "comment"&#125;,</div><div class="line">    h2(&#123;className: "commentAuthor"&#125;, author),</div><div class="line">    content</div><div class="line">  );</div><div class="line">&#125;</div><div class="line"></div><div class="line">const commentList = div(&#123;className: "commentList"&#125;, </div><div class="line">  makeComment("张三", "这是条评论"),</div><div class="line">  makeComment("李四“，”这是**另一条**评论“）</div><div class="line">);</div></pre></td></tr></table></figure>
<hr>
<h2 id="添加-Markdown-语法格式的评论"><a href="#添加-Markdown-语法格式的评论" class="headerlink" title="添加 Markdown 语法格式的评论"></a>添加 Markdown 语法格式的评论</h2><p>Markdown 是一种简单的格式化内联文本的方式。例如，用星号包裹文本将会使其强调突出。</p>
<p>为了显示Html，Domcom提供了html部件。使用html部件时会将用户内容渲染为dom结构，面对这种需求务必对可能的安全风险保持警惕。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> md = Remarkable();</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeComment</span>(<span class="params">author, content</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> div(&#123;<span class="attr">className</span>: <span class="string">"comment"</span>&#125;,</div><div class="line">    h2(&#123;<span class="attr">className</span>: <span class="string">"commentAuthor"</span>&#125;, author),</div><div class="line">    html(md.render(content))</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用html部件会将text渲染为dom结构。因此前一个步骤所使用的html部件的结果已经正好是我们想要的。当然这会存在安全风险，是编码时要注意的。Domcom并没有为此就特意将api搞得更丑，而是在文档中多加提醒。并且在api上更方便让程序员添加转义处理，方法是让html部件函数可以提供一个变换函数作为transform参数。上述代码在Domcom中可以这样实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> md = Remarkable();</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">convertMarkdown</span>(<span class="params">text</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> md.render(text);</div><div class="line">&#125;;</div><div class="line"><span class="keyword">const</span> comment = <span class="function"><span class="keyword">function</span> (<span class="params">author, content</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> div(&#123;<span class="attr">className</span>: <span class="string">"comment"</span>&#125;,</div><div class="line">    h2(&#123;<span class="attr">className</span>: <span class="string">"commentAuthor"</span>&#125;, author),</div><div class="line">    html(content, convertMarkdown)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>甚至可以更简单：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> md = Remarkable();</div><div class="line"><span class="keyword">const</span> comment = <span class="function"><span class="keyword">function</span> (<span class="params">author, content</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> div(&#123;<span class="attr">className</span>: <span class="string">"comment"</span>&#125;,</div><div class="line">    h2(&#123;<span class="attr">className</span>: <span class="string">"commentAuthor"</span>&#125;, author),</div><div class="line">    html(content, md.render.bind(md))</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="接入数据模型"><a href="#接入数据模型" class="headerlink" title="接入数据模型"></a>接入数据模型</h2><p>到目前为止，我们已经在源代码里面直接插入了评论数据。让我们将这些评论数据抽出来，放在一个 JSON 格式的变量中，然后将这个 JSON 数据渲染到评论列表。到最后，数据将会来自服务器，但是现在直接写在源代码中：  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> data = [</div><div class="line">  &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">author</span>: <span class="string">"Pete Hunt"</span>, <span class="attr">text</span>: <span class="string">"This is one comment"</span>&#125;,</div><div class="line">  &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">author</span>: <span class="string">"Jordan Walke"</span>, <span class="attr">text</span>: <span class="string">"This is *another* comment"</span>&#125;</div><div class="line">];</div></pre></td></tr></table></figure>
<p>我们将commentList改成函数以便传递数据。利用each部件函数可以动态地监控数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentList</span>(<span class="params">comments</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> each(&#123;<span class="attr">className</span>: <span class="string">"commentList"</span>&#125;, comments, <span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> comment(item.author, item.text);</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在需要把commentList在commentBox的使用方式改为函数调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">      h1(<span class="string">"Comments"</span>),</div><div class="line">      makeCommentList(data),</div><div class="line">      commentForm</div><div class="line">    );</div></pre></td></tr></table></figure>
<p>在Domcom中并不需要层次化传递数据。我们这里并不一定要把commentBox改成部件函数。本教程会在后面的步骤中做这样的改变。是否这样做完全可以视应用需求而定，不是框架的要求。</p>
<h2 id="从服务器获取数据"><a href="#从服务器获取数据" class="headerlink" title="从服务器获取数据"></a>从服务器获取数据</h2><p>现在我们需要改变产生commentBox的方法。为了传入url参数，我们用函数产生部件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> commentBox = makeCommentBox(<span class="string">"/api/comments"</span>);</div><div class="line">commentBox.mount()</div></pre></td></tr></table></figure>
<p>根据现在的需求，我们把commentBox改成部件函数，把url作为参数传递。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentBox</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> comments = [];</div><div class="line">  <span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">      h1(<span class="string">"Comments"</span>),</div><div class="line">      makeCommentList(comments),</div><div class="line">      commentForm</div><div class="line">    );</div><div class="line">  commentBox.on(<span class="string">'didMount'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        comments.replaceAll(data);</div><div class="line">        dc.render();</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(url, status, err.toString());</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> commentBox;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码中，didMount事件的回调函数并不需要象在React的代码中那样引用this.props.url, 也不需要调用this.setState，只是使用函数参数url和局部变量comments，因此不需要把它设计为commentBox的方法，也不需要使用bind绑定this，用闭包函数就好了。</p>
<p>可以看到，Domcom中数据和部件解耦得更加彻底，同时传递和管理数据反而更加灵活便利了。</p>
<hr>
<h3 id="从服务器动态获取数据"><a href="#从服务器动态获取数据" class="headerlink" title="从服务器动态获取数据"></a>从服务器动态获取数据</h3><p>现在实现从服务器动态获取数据的代码。</p>
<p>这里，我们用新的从服务器拿到的评论数组来替换掉老的评论数组，然后 UI 自动更新。有了这种反应机制，实现实时更新就仅需要一小点改动。在这里我们使用简单的轮询，但是你也可以很容易地改为使用 WebSockets 或者其他技术。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"> function makeCommentBox(url = “api/comments”, pollInterval = 2000) &#123;</div><div class="line">   const comments = [];</div><div class="line">   const commentBox = div(&#123;className: "commentBox"&#125;, </div><div class="line">       h1("Comments"),</div><div class="line">       makeCommentList(comments),</div><div class="line">       commentForm</div><div class="line">   );</div><div class="line">   </div><div class="line">   function loadCommentsFromServer() &#123;</div><div class="line">     $.ajax(&#123;</div><div class="line">       url: url,</div><div class="line">       dataType: 'json',</div><div class="line">       cache: false,</div><div class="line">       success: function(data) &#123;</div><div class="line">         comments.replaceAll(data);</div><div class="line">         dc.render();</div><div class="line">       &#125;,</div><div class="line">       error: function(xhr, status, err) &#123;</div><div class="line">         console.error(url, status, err.toString());</div><div class="line">       &#125;</div><div class="line">     &#125;);</div><div class="line">   &#125;,</div><div class="line">     </div><div class="line">   commentBox.on('didMount', function()&#123;</div><div class="line">     loadCommentsFromServer();</div><div class="line">     setInterval(loadCommentsFromServer, pollInterval)</div><div class="line">   &#125;);</div><div class="line">   </div><div class="line">   return commentBox;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码中，我们将有关代码重构为loadCommentsFromServer，因为与前一个步骤类似的理由，依然只要用闭包函数就好，不必将其设定为commentBox的方法。    </p>
<hr>
<h2 id="添加新的评论"><a href="#添加新的评论" class="headerlink" title="添加新的评论"></a>添加新的评论</h2><p>现在是时候构造表单了。我们的 CommentForm 部件应该询问用户的名字和评论内容，然后发送一个请求到服务器，保存这条评论。</p>
<p>考虑到后面有传递回调函数参数的需求，现在就直接将commentForm改为用函数实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentForm</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> form(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">    text(&#123;<span class="attr">placeholder</span>: <span class="string">"Your name"</span>&#125;),</div><div class="line">    text(&#123;<span class="attr">placeholder</span>: <span class="string">"Say something..."</span>&#125;),</div><div class="line">    input(&#123;<span class="attr">type</span>: <span class="string">"submit"</span>, <span class="attr">value</span>: <span class="string">"Post"</span>&#125;)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="处理输入事件"><a href="#处理输入事件" class="headerlink" title="处理输入事件"></a>处理输入事件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentForm</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> newComment = &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  <span class="keyword">return</span> form(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Your name"</span>,</div><div class="line">      <span class="attr">value</span>: newComment.author,</div><div class="line">      <span class="attr">onchange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.author = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Say something..."</span>,</div><div class="line">      <span class="attr">value</span>: newComment.text,</div><div class="line">      <span class="attr">onchange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.text = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    input(&#123;<span class="attr">type</span>: <span class="string">"submit"</span>, <span class="attr">value</span>: <span class="string">"Post"</span>&#125;)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码中，除了text部件，没有别的地方会改变newComment的内容，text部件不需要依据newComment动态刷新。如果需要text部件自动响应newComment的数据变化，可以使用响应函数, 这里可以用flow.bind, 就象这样：<code>text({..., value: flow.bind(newComment, &#39;author&#39;), ...})</code>。</p>
<p>如果使用指令，上面的代码可以更加简化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">dc.directives(<span class="string">'model'</span>, dc.$model);    </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentForm</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> newComment = &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  <span class="keyword">const</span> &#123;author$, text$&#125; = dc.bindings(newComment);</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> form(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Your name"</span>,</div><div class="line">      <span class="attr">$model</span>: author$</div><div class="line">    &#125;),</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Say something..."</span>,</div><div class="line">      <span class="attr">$model</span>: text$</div><div class="line">    &#125;),</div><div class="line">    input(&#123;<span class="attr">type</span>: <span class="string">"submit"</span>, <span class="attr">value</span>: <span class="string">"Post"</span>&#125;)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>text部件（也包括其它input部件）甚至可以这样写：<code>text({ placeholder: &quot;Your name&quot;}， author$)</code>。这种写法和使用指令的写法都只是不同程度的语法糖而已，本质上和不用指令的代码是一样的。</p>
<hr>
<h3 id="表单交互"><a href="#表单交互" class="headerlink" title="表单交互"></a>表单交互</h3><p>让我们使表单可交互。当用户提交表单的时候，我们应该清空表单，发送一个请求到服务器，然后刷新评论列表。首先，让我们监听表单的提交事件，然后清空表单。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentForm</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> newComment = &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  <span class="keyword">return</span> form(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Your name"</span>,</div><div class="line">      <span class="attr">value</span>: newComment.author,</div><div class="line">      <span class="attr">onchange</span>:<span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.author = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Say something..."</span>,</div><div class="line">      <span class="attr">value</span>: newComment.text,</div><div class="line">      <span class="attr">onchange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.text = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    input(&#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">"submit"</span>, </div><div class="line">      <span class="attr">value</span>: <span class="string">"Post"</span>,</div><div class="line">      <span class="attr">onsubmit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>) </span>&#123;</div><div class="line">        event.preventDefault = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">var</span> author = newComment.author.trim();</div><div class="line">        <span class="keyword">var</span> text = newComment.text.trim();</div><div class="line">        <span class="keyword">if</span> (!text || !author) &#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        extend(newComment, &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;);</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> send request to the server</span></div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在修改makeCommentBox，向makeCommentForm传递一个回调函数作为参数以便处理提交数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentBox</span>(<span class="params">url, pollInterval = <span class="number">2000</span></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> comments = [];</div><div class="line">  <span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">      h1(<span class="string">"Comments"</span>),</div><div class="line">      makeCommentList(comments),</div><div class="line">      makeCommentForm(<span class="function"><span class="keyword">function</span>(<span class="params">newComment</span>)</span>&#123;</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> submit to the server and refresh the list</span></div><div class="line">      &#125;)</div><div class="line">  );</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadCommentsFromServer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        comments.replaceAll(data);</div><div class="line">        dc.render();</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(url, status, err.toString());</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">    </div><div class="line">  commentBox.on(<span class="string">'didMount'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    loadCommentsFromServer();</div><div class="line">    setInterval(loadCommentsFromServer, pollInterval)</div><div class="line">  &#125;);</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> commentBox;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="调用回调并清除评论"><a href="#调用回调并清除评论" class="headerlink" title="调用回调并清除评论"></a>调用回调并清除评论</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentForm</span>(<span class="params">submitComment</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> newComment = &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;;</div><div class="line">  <span class="keyword">return</span> form(&#123;<span class="attr">className</span>: <span class="string">"commentForm"</span>&#125;,</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Your name"</span>,</div><div class="line">      <span class="attr">value</span>: newComment.author,</div><div class="line">      <span class="attr">onchange</span>:<span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.author = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    text(&#123;</div><div class="line">      <span class="attr">placeholder</span>: <span class="string">"Say something..."</span>,</div><div class="line">      <span class="attr">value</span>: newComment.text,</div><div class="line">      <span class="attr">onchange</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>)</span>&#123;</div><div class="line">        newComment.text = node.value;</div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    input(&#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">"submit"</span>, </div><div class="line">      <span class="attr">value</span>: <span class="string">"Post"</span>,</div><div class="line">      <span class="attr">onsubmit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event, node</span>) </span>&#123;</div><div class="line">        event.preventDefault = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">var</span> author = newComment.author.trim();</div><div class="line">        <span class="keyword">var</span> text = newComment.text.trim();</div><div class="line">        <span class="keyword">if</span> (!text || !author) &#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        submitComment(newComment);</div><div class="line">        extend(newComment, &#123;<span class="attr">author</span>: <span class="string">''</span>, <span class="attr">text</span>: <span class="string">''</span>&#125;);</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="发起POST请求并更新状态"><a href="#发起POST请求并更新状态" class="headerlink" title="发起POST请求并更新状态"></a>发起POST请求并更新状态</h3><p>在传递给CommentForm的回调handleCommentSubmit中添加ajax代码，发起服务器POST请求，成功时调用comments.replaceAll。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentBox</span>(<span class="params">url, pollInterval = <span class="number">2000</span></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> comments = [];</div><div class="line">  <span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">      h1(<span class="string">"Comments"</span>),</div><div class="line">      makeCommentList(comments),</div><div class="line">      makeCommentForm(<span class="function"><span class="keyword">function</span>(<span class="params">newComment</span>)</span>&#123;</div><div class="line">        $.ajax(&#123;</div><div class="line">          <span class="attr">url</span>: url,</div><div class="line">          <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">          <span class="attr">type</span>: <span class="string">'POST'</span>,</div><div class="line">          <span class="attr">data</span>: newComment,</div><div class="line">          <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">            comments.replaceAll(data);</div><div class="line">            dc.render();</div><div class="line">          &#125;,</div><div class="line">          <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.error(<span class="keyword">this</span>.props.url, status, err.toString());</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">      &#125;)</div><div class="line">  );</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadCommentsFromServer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        comments.replaceAll(data);</div><div class="line">        dc.render();</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(url, status, err.toString());</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">    </div><div class="line">  commentBox.on(<span class="string">'didMount'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    loadCommentsFromServer();</div><div class="line">    setInterval(loadCommentsFromServer, pollInterval)</div><div class="line">  &#125;);</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> commentBox;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="优化：提前更新"><a href="#优化：提前更新" class="headerlink" title="优化：提前更新"></a>优化：提前更新</h2><p>我们的应用现在已经完成了所有功能，但是在新添加的评论出现在列表之前，必须等待请求完成，所以感觉很慢。我们可以直接添加这条评论到列表中，从而使应用感觉更快。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCommentBox</span>(<span class="params">url, pollInterval = <span class="number">2000</span></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> comments = [];</div><div class="line">  <span class="keyword">const</span> commentBox = div(&#123;<span class="attr">className</span>: <span class="string">"commentBox"</span>&#125;, </div><div class="line">      h1(<span class="string">"Comments"</span>),</div><div class="line">      makeCommentList(comments),</div><div class="line">      makeCommentForm(<span class="function"><span class="keyword">function</span>(<span class="params">newComment</span>)</span>&#123;            </div><div class="line">        $.ajax(&#123;</div><div class="line">          <span class="attr">url</span>: url,</div><div class="line">          <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">          <span class="attr">type</span>: <span class="string">'POST'</span>,</div><div class="line">          <span class="attr">data</span>: newComment,</div><div class="line">          <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">            comments.replaceAll(data);</div><div class="line">            dc.render();</div><div class="line">          &#125;,</div><div class="line">          <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.error(url, status, err.toString());</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">        comments.push(newComment);</div><div class="line">        commentBox.render();</div><div class="line">      &#125;)</div><div class="line">  );</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadCommentsFromServer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      <span class="attr">url</span>: url,</div><div class="line">      <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">      <span class="attr">cache</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        comments.replaceAll(data);</div><div class="line">        dc.render();</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, status, err</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(url, status, err.toString());</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">    </div><div class="line">  commentBox.on(<span class="string">'didMount'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    loadCommentsFromServer();</div><div class="line">    setInterval(loadCommentsFromServer, pollInterval);</div><div class="line">  &#125;);</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> commentBox;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>本文用Domcom通过一些步骤来构造评论框。我们看到Domcom的代码虽然没有是用JSX，但是依然很简洁（即使比带JSX的React代码也更简洁)，涉及的新概念很少，学习曲线非常平坦，更加贴近javascript最普遍的语言特性。而且我可以告诉大家，Domcom的实现原理可以让它达到比React更好的运行性能。</p>
<p>考虑到当前web前端的主流习惯，本文以javascript作为Domcom演示语言。Domcom框架是以用coffee-script开发的，但从使用上可以良好地用在ES6或ES5环境中，并且以UMD风格支持模块化。如果使用coffee-script语言来开发Domcom的应用程序，代码将更为简洁优雅。</p>
<hr>
<p>祝贺你你刚刚通过一些简单步骤构造了一个评论框。现在你可以去学习一个<a href="https://github.com/taijiweb/domcom/blob/master/doc/Chinese/%E4%BB%8B%E7%BB%8D%E5%92%8C%E8%BE%85%E5%AF%BC%E6%95%99%E7%A8%8B.md">更全面的辅导教程</a>, 了解更多关于<a href="https://github.com/taijiweb/domcom/blob/master/doc/Chinese/%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86.md"> Domcom 的概念和原理</a>，或者去看看 <a href="https://github.com/taijiweb/domcom/blob/master/doc/Chinese/API%E5%8F%82%E8%80%83.md">Domcomm API参考</a>。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://github.com/taijiweb/2016/08/28/Domcom评论框教程/" data-id="ciu0w4vlf0001q5bh9uptxge7" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Domcom/">Domcom</a><a href="/tags/framework/">framework</a><a href="/tags/javascript/">javascript</a></div><div class="post-nav"><a href="/2016/10/08/有了rewrap，老板再也不担心我的正则了/" class="pre">有了rewrap，老板再也不担心我的正则了</a><a href="/2016/08/26/前端简史演义/" class="next">前端演义</a></div><div data-thread-key="2016/08/28/Domcom评论框教程/" data-title="Domcom评论框教程" data-url="http://github.com/taijiweb/2016/08/28/Domcom评论框教程/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/08/28/Domcom评论框教程/" data-title="Domcom评论框教程" data-url="http://github.com/taijiweb/2016/08/28/Domcom评论框教程/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://github.com/taijiweb"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Domcom/">Domcom</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Domcom/" style="font-size: 15px;">Domcom</a> <a href="/tags/framework/" style="font-size: 15px;">framework</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/08/有了rewrap，老板再也不担心我的正则了/">有了rewrap，老板再也不担心我的正则了</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/28/Domcom评论框教程/">Domcom评论框教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/26/前端简史演义/">前端演义</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/09/从React教程学Domcom/">React 与 Domcom 面对面 -- 评论框教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/08/从实例看React与Domcom/">React与Domcom面对面 -- 一些代码对比</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/05/domcom比ReactJS好在哪里？/">React与Domcom面对面 -- domcom 好在哪里？</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/29/框架的演进/">前端编程方法和框架的演进</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/28/hello-world/">taijweb's blog</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.github.com/taijiweb" title="taijiweb's github" target="_blank">taijiweb's github</a><ul></ul><a href="http://www.github.com/chaosim" title="chaosim's github" target="_blank">chaosim's github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">taijiweb's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'taijiweb'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>